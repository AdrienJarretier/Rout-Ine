<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <title>Chargement du planning</title>
  <link rel="stylesheet" href="style.css">
  <script src="jquery-latest.min.js"></script>
  <script type="text/javascript" src="utils.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <!-- Leaflet -->
  <link rel="stylesheet" href="leaflet/leaflet.css">
  <script src="leaflet/leaflet.js"></script>
  <!-- -->
  <!-- Bootstrap -->
  <link href="bootstrap-3.3.7-dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
  <!-- -->
  <script src='common.js'></script>
  <script src='mapFunctions.js'></script>
  <script type="text/javascript">
  'use strict';
  /*
  Strict mode makes several changes to normal JavaScript semantics.
  First, strict mode eliminates some JavaScript silent errors by changing them to throw errors.
  Second, strict mode fixes mistakes that make it difficult for JavaScript engines to perform optimizations:
  strict mode code can sometimes be made to run faster than identical code that's not strict mode.
  Third, strict mode prohibits some syntax likely to be defined in future versions of ECMAScript.
  */

  // execute le javascript quand la page est completement chargee
  $(document).ready(function() {

    let map = initMap();


    $('#errorTooSmall').hide();

    let socket = io.connect();

    $('#startGa').prop("disabled", false);;
    $('#stopGa').prop("disabled", true);;

    $('#startGa').click(function() {

      socket.emit('start',

        {
          nbTrips: $('#nbTrips').val(),
          popSize: $('#popSize').val(),
          stopTime: $('#stopTime').val(),
          maxStops: $('#maxStops').val()
        }

      );

    });

    socket.on('started', function() {

      $('#errorTooSmall').hide();
      $('#infos').empty();

      $('#startGa').prop("disabled", true);;
      $('#stopGa').prop("disabled", false);;


    });


    socket.on('stopped', function() {

      $('#startGa').prop("disabled", false);;
      $('#stopGa').prop("disabled", true);;

    });

    socket.on('maxTooSmall', function() {

      $('#errorTooSmall').show();

    });

    $('#stopGa').click(function() {

      socket.emit('stop');

    });

    let routes = [];

    socket.on('bestResult', function(bestResult) {

      console.log(bestResult);

      let markersColors = ["darkred", "blue", "green", "orange", "black", "purple"];

      let tours = bestResult.trips;

      routes.forEach(function(layer) {
        map.removeLayer(layer);
      });

      let infosList = $('#infos');

      infosList.append($('<div class="row">').append($('<div class="col-xs-12">')).html("génération " + bestResult.genNumber));
      infosList.append($('<div class="row">').append($('<div class="col-xs-12">')).text('id partition : ' + bestResult.partitionId));
      infosList.append($('<div class="row">').append($('<div class="col-xs-12">')).text('obtenu en ' + utils.s2hours(bestResult.totalTime / 1000, true)));

      for (let i in tours) {

        let tour = tours[i];

        let colorColumnSize = 5;

        infosList.append($('<div class="row">')
          .append($('<div class="col-xs-' + colorColumnSize + '">').text(markersColors[i] + ' : ').css('color', markersColors[i]))
          .append($('<div class="col-xs-' + (12 - colorColumnSize) + '">').text(utils.s2hours(tour.trip.trips[0].duration, false) + '( ' + (tour.addresses.features.length - 1) + ' )').css('color', markersColors[i])));

        let routeLayer = L.geoJSON(tour.trip.trips[0].geometry).addTo(map);

        routeLayer.setStyle(function(feature) {
          return {
            color: markersColors[i]
          };
        });

        routes.push(routeLayer);

      }

      infosList.append($('<br>'));

    });


  });
  </script>
</head>

<body>
  <h1>Chargement du planning</h1>
  <div class="container-fluid">
    <div class="row">
      <div class="col-xs-3">
        <form>
          <div class="form-group">
            <label for="nbTrips">Nombre de tournées : </label>
            <input class="form-control" id="nbTrips" type="number">
          </div>
          <div class="form-group">
            <label for="popSize">PopSize : </label>
            <input class="form-control" id="popSize" type="number">
          </div>
          <div class="form-group">
            <label for="stopTime">Temps d'arrêt par adresse : </label>
            <input class="form-control" id="stopTime" type="number"> m
          </div>
          <div class="form-group">
            <label for="maxStops">Nombre maximum de livraisons par tournee : </label>
            <input class="form-control" id="maxStops" type="number">
            <div id="errorTooSmall" class="alert alert-danger" role="alert">Maximum trop petit</div>
          </div>
          <div class="form-group">
            <label for="inputSchedule">Sélection du planning</label>
            <input type="file" id="inputSchedule">
          </div>
          <div class="form-group">
            <label for="daySelection">Jour à calculer</label>
            <select id="daySelection" class="form-control">
            </select>
          </div>
          <button id="startGa" class="btn btn-primary" type="button">Démarrer le calcul</button>
          <button id="stopGa" class="btn btn-danger" type="button">Stop</button>
        </form>
      </div>
      <div class="col-xs-6">
        <div id="map"></div>
      </div>
      <div class="col-xs-3">
        <p id="infos">
        </p>
      </div>
    </div>
  </div>
</body>

</html>
