<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Localisation bénéficiaires</title>
  <link href='json-formatter/JSONFormatter.css' media='all' rel='stylesheet' type='text/css'>
  <script src="json-formatter/JSONFormatter.js"></script>
  <link rel="stylesheet" href="leaflet/leaflet.css">
  <script src="leaflet/leaflet.js"></script>
  <script type="text/javascript" src="jquery-latest.min.js"></script>
  <!-- groupedlayercontrol -->
  <script src='leaflet-groupedlayercontrol-0.6.0/dist/leaflet.groupedlayercontrol.min.js'></script>
  <link rel="stylesheet" href="leaflet-groupedlayercontrol-0.6.0/dist/leaflet.groupedlayercontrol.min.css">
  <!--  -->
  <script src='utils.js'></script>
  <!-- awesome-numbered-marker -->
  <link rel="stylesheet" href="Leaflet.awesome-numbered-marker-master/src/leaflet_awesome_number_markers.css" />
  <script src="Leaflet.awesome-numbered-marker-master/src/leaflet_awesome_number_markers.js"></script>
  <!--  -->
  <link rel="stylesheet" href="style.css" />
  <script type="text/javascript">
  'use strict';
  /*
  Strict mode makes several changes to normal JavaScript semantics.
  First, strict mode eliminates some JavaScript silent errors by changing them to throw errors.
  Second, strict mode fixes mistakes that make it difficult for JavaScript engines to perform optimizations:
  strict mode code can sometimes be made to run faster than identical code that's not strict mode.
  Third, strict mode prohibits some syntax likely to be defined in future versions of ECMAScript.
  */

  const MAPBOX_ACCESS_TOKEN = 'pk.eyJ1IjoibXJmcmVlemUiLCJhIjoiY2owNWg2a2kyMDA2cjMycGZndzA2ZzZneCJ9.-wsVwihnGBO41Z9FvV_UAQ';

  // execute le javascript quand la page est completement chargee
  $(document).ready(function() {
    let mymap = L.map('map').setView([43.93002883039214, 2.1581183602941194], 13);

    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
      maxZoom: 18,
      id: 'mapbox.streets',
      accessToken: MAPBOX_ACCESS_TOKEN
    }).addTo(mymap);

    function addLine(string, line) {
      return string + '<br>' + line;
    }

    function addressesMarkers(waypoints, addresses, color) {

      function markerMaker(waypoint, address_index) {

        let lat = waypoint.location[1];
        let lng = waypoint.location[0];

        let marker = L.marker([lat, lng], {
          icon: new L.AwesomeNumberMarkers({
            number: waypoint.waypoint_index,
            markerColor: color
          })
        });

        let feature = addresses.features[address_index];

        let p = feature.properties;
        let popContent = p.label + (p.special != undefined ? ', ' + p.special : '');

        for (let b of p.beneficiaries) {

          let line = b.name;

          let isAnniversary = false;

          if (b.birthdate != null) {

            let now = new Date(Date.now());
            let birthdate = new Date(b.birthdate);

            isAnniversary = now.getDate() == birthdate.getDate() && now.getMonth() == birthdate.getMonth();

            // l'age de la personne en millisecondes
            let age = now - birthdate;

            let years = age / 31557600000

            line += ', ' + Math.floor(years) + ' ans - ';
          }

          line += b.address_additional + ' - ';

          popContent = addLine(popContent, line);

          if (isAnniversary) {

            popContent = addLine(popContent, '<img src="cake-with-2-candles-md.png">');
          }

        }

        marker.bindPopup(popContent);

        return marker;
      }


      let markersLayer = L.layerGroup();

      let index = 0;

      for (let i in waypoints) {

        let w = waypoints[i];

        if (w.waypoint_index == undefined)
          w.waypoint_index = index++;

        markersLayer.addLayer(markerMaker(w, i));
      }

      return markersLayer;
    }


    // function tripLayer(geometry, color) {

    //   let routeLayer = L.geoJSON(geometry);
    //   routeLayer.setStyle(function(feature) {
    //     return {
    //       color: color
    //     };
    //   });

    //   return routeLayer;
    // }

    // function layerGroup(resultTrip, tripColor) {
    //   return L.layerGroup([
    //     tripLayer(resultTrip, tripColor),
    //     addressesMarkers(resultTrip)
    //   ]);
    // }

    function s2hours(seconds) {

      let hours = Math.floor(seconds / 3600);
      let minutes = Math.ceil((seconds % 3600) / 60);

      return hours + ' h ' + minutes + ' min';
    }

    function m2km(meters) {

      return (Math.ceil(meters / 10) / 100) + ' km';
    }

    // demande au serveur les voyages
    $.ajax({
      type: "GET",
      dataType: "json",
      url: "testTournee",
      success: function(tours, textStatus, jqXHR) {

        let markersColors = ["darkred", "blue"];

        for (let i in tours) {

          let data = tours[i];

          let groupName = 'Tournée ' + i;

          let overlayMaps = {
            [groupName]: {}
          };

          let tripNames = [];

          console.log(data);




          let originalRoute = data.original.routes[0];

          let originalRouteLayer = L.geoJSON(originalRoute.geometry);
          originalRouteLayer.setStyle(function(feature) {
            return {
              color: markersColors[i]
            };
          });

          let group = L.layerGroup([
            originalRouteLayer,
            addressesMarkers(data.original.waypoints, data.addresses, markersColors[i])
          ]);

          let seconds = originalRoute.duration;

          let meters = originalRoute.distance;

          let tripName = 'trajet original (' + s2hours(seconds) + ') ' + m2km(meters);

          tripNames.push(tripName);

          overlayMaps[groupName][tripName] = group;




          let osrmTrip = data.osrmTrip.trips[0];

          let osrmTripLayer = L.geoJSON(osrmTrip.geometry);
          osrmTripLayer.setStyle(function(feature) {
            return {
              color: markersColors[i]
            };
          });

          let groupOsrmTrip = L.layerGroup([
            osrmTripLayer,
            addressesMarkers(data.osrmTrip.waypoints, data.addresses, markersColors[i])
          ]);

          seconds = osrmTrip.duration;

          meters = osrmTrip.distance;

          tripName = 'trajet par osrm trip (' + s2hours(seconds) + ') ' + m2km(meters);

          tripNames.push(tripName);

          overlayMaps[groupName][tripName] = groupOsrmTrip;




          var options = {
            // Make the "trips" group exclusive (use radio inputs)
            exclusiveGroups: [groupName]
          };

          overlayMaps[groupName][tripNames[0]].addTo(mymap);

          L.control.groupedLayers(null, overlayMaps, options).addTo(mymap);

        }

      },
      error: function(jqXHR, textStatus, errorThrown) {
        console.log("error : " + textStatus + errorThrown);
      }
    });

  });
  </script>
</head>

<body>
  <h1><a href="index.html">Localisation des bénéficiaires</a></h1>
  <nav>
    <ul>
      <li><a href="simu.html">simulation</a></li>
      <li><a href="socketio.html">recherche de meilleures tournées</a></li>
      <li><a href="bestFromGa.html">Voir le meilleur resultat obtenu avec l'algorithme</a></li>
    </ul>
  </nav>
  <!--   <p>
    temps total cumulé : <span id='totalTime'></span> (temps max : <span id='maxTime'></span>, trajet : <span id='maxTripNum'></span> )
    <br> distance totale : <span id='totalDistance'></span>
  </p> -->
  <div id="map"></div>
</body>

</html>
