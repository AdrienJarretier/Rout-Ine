<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Localisation bénéficiaires</title>
  <link href='json-formatter/JSONFormatter.css' media='all' rel='stylesheet' type='text/css'>
  <script src="json-formatter/JSONFormatter.js"></script>
  <link rel="stylesheet" href="leaflet/leaflet.css" />
  <script src="leaflet/leaflet.js"></script>
  <script type="text/javascript" src="jquery-latest.min.js"></script>
  <style>
  #mapid {
    height: 720px;
  }
  </style>
  <script type="text/javascript">
  'use strict';
  /*
  Strict mode makes several changes to normal JavaScript semantics.
  First, strict mode eliminates some JavaScript silent errors by changing them to throw errors.
  Second, strict mode fixes mistakes that make it difficult for JavaScript engines to perform optimizations:
  strict mode code can sometimes be made to run faster than identical code that's not strict mode.
  Third, strict mode prohibits some syntax likely to be defined in future versions of ECMAScript.
  */

  // execute le javascript quand la page est completement chargee
  $(document).ready(function() {
    let mymap = L.map('mapid').setView([43.93002883039214, 2.1581183602941194], 13);


    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
      maxZoom: 18,
      id: 'mapbox.streets',
      accessToken: 'pk.eyJ1IjoibXJmcmVlemUiLCJhIjoiY2owNWg2a2kyMDA2cjMycGZndzA2ZzZneCJ9.-wsVwihnGBO41Z9FvV_UAQ'
    }).addTo(mymap);

    function addLine(string, line) {
      return string + '<br>' + line;
    }

    // demande au serveur le json des informations beneficiares pour les afficher
    $.ajax({
      type: "GET",
      dataType: "json",
      url: "beneficiaries",
      success: function(data, textStatus, jqXHR) {

        console.log(data);

        function onEachFeature(feature, layer) {
          let p = feature.properties;
          let popContent = p.label + (p.additional.length > 0 ? ', ' + p.additional : '');

          for (let b of p.beneficiaries) {

            popContent = addLine(popContent, b.name);

            if (b.birthdate != null) {

              // l'age de la personne en millisecondes
              let age = Date.now() - (new Date(b.birthdate));

              let years = age / 31557600000

              popContent += ', ' + Math.floor(years) + ' ans';
            }
          }

          for (let phone of p.phones) {
            popContent = addLine(popContent, phone);
          }
          layer.bindPopup(popContent);
        }
        L.geoJSON(data, {
          onEachFeature: onEachFeature
        }).addTo(mymap);



      },
      error: function(jqXHR, textStatus, errorThrown) {
        console.log("error : " + textStatus + errorThrown);
      }
    });

    // demande au serveur le geojson du voyage
    $.ajax({
      type: "GET",
      dataType: "json",
      url: "trip",
      success: function(data, textStatus, jqXHR) {

        let routeLayer = L.geoJSON().addTo(mymap);
        routeLayer.addData(data.geometry);
        routeLayer.setStyle(function(feature) {
          return {
            color: "red"
          };
        });
      },
      error: function(jqXHR, textStatus, errorThrown) {
        console.log("error : " + textStatus + errorThrown);
      }
    });

  });
  </script>
</head>

<body>
  <h1>Localisation des bénéficiaires</h1>
  <div id="mapid"></div>
</body>

</html>
